From 2b60f9b61e8aa1b2cec7109bbe8169849596fd77 Mon Sep 17 00:00:00 2001
From: snowman2 <alansnow21@gmail.com>
Date: Fri, 30 Jul 2021 19:32:21 -0500
Subject: [PATCH] BUG: Add PyPy cython array implementation

---
 pyproj/_compat.pyx      | 16 ++++++++++++++++
 pyproj/_geod.pyx        | 10 ++++------
 pyproj/_transformer.pyx |  3 +--
 setup.py                |  2 ++
 4 files changed, 23 insertions(+), 8 deletions(-)

diff --git a/pyproj/_compat.pyx b/pyproj/_compat.pyx
index 5d444ae..caef7f2 100644
--- a/pyproj/_compat.pyx
+++ b/pyproj/_compat.pyx
@@ -1,3 +1,5 @@
+import array
+
 from pyproj.compat import pystrdecode
 
 
@@ -5,3 +7,17 @@ cdef cstrdecode(const char *instring):
     if instring != NULL:
         return pystrdecode(instring)
     return None
+
+
+IF CTE_PYTHON_IMPLEMENTATION == "CPython":
+    from cpython cimport array
+
+    cdef array.array _ARRAY_TEMPLATE = array.array("d", [])
+
+    def empty_array(int npts):
+        return array.clone(_ARRAY_TEMPLATE, npts, zero=False)
+
+ELSE:
+    # https://github.com/pyproj4/pyproj/issues/854
+    def empty_array(int npts):
+        return array.array("d", [float("NaN")] * npts)
diff --git a/pyproj/_geod.pyx b/pyproj/_geod.pyx
index 90d7e26..f2ff500 100644
--- a/pyproj/_geod.pyx
+++ b/pyproj/_geod.pyx
@@ -1,12 +1,11 @@
 include "base.pxi"
 
 cimport cython
-from cpython cimport array
 from libc.math cimport ceil, isnan, round
 
-import array
 from collections import namedtuple
 
+from pyproj._compat import empty_array
 from pyproj.compat import cstrencode, pystrdecode
 from pyproj.enums import GeodIntermediateFlag
 from pyproj.exceptions import GeodError
@@ -232,7 +231,6 @@ cdef class Geod:
             out_azis is not None \
             or (flags & GEOD_INTER_FLAG_AZIS_MASK) == GEOD_INTER_FLAG_AZIS_KEEP
 
-        cdef array.array array_template = array.array("d", [])
         cdef PyBuffWriteManager lons_buff
         cdef PyBuffWriteManager lats_buff
         cdef PyBuffWriteManager azis_buff
@@ -277,11 +275,11 @@ cdef class Geod:
 
             with gil:
                 if out_lons is None:
-                    out_lons = array.clone(array_template, npts, zero=False)
+                    out_lons = empty_array(npts)
                 if out_lats is None:
-                    out_lats = array.clone(array_template, npts, zero=False)
+                    out_lats = empty_array(npts)
                 if out_azis is None and store_az:
-                    out_azis = array.clone(array_template, npts, zero=False)
+                    out_azis = empty_array(npts)
 
                 lons_buff = PyBuffWriteManager(out_lons)
                 lats_buff = PyBuffWriteManager(out_lats)
diff --git a/pyproj/_transformer.pyx b/pyproj/_transformer.pyx
index 4b2df52..451297b 100644
--- a/pyproj/_transformer.pyx
+++ b/pyproj/_transformer.pyx
@@ -1,7 +1,6 @@
 include "base.pxi"
 
 cimport cython
-from cpython cimport array
 from cpython.mem cimport PyMem_Free, PyMem_Malloc
 
 import copy
@@ -811,7 +810,7 @@ cdef class _Transformer(Base):
     def _transform_sequence(
         self,
         Py_ssize_t stride,
-        array.array inseq,
+        object inseq,
         bint switch,
         object direction,
         bint time_3rd,
diff --git a/setup.py b/setup.py
index 33d0228..a2fde67 100644
--- a/setup.py
+++ b/setup.py
@@ -1,4 +1,5 @@
 import os
+import platform
 import subprocess
 import sys
 from distutils.spawn import find_executable
@@ -183,6 +184,7 @@ def get_extension_modules():
             "CTE_PROJ_VERSION_MAJOR": int(proj_version_major),
             "CTE_PROJ_VERSION_MINOR": int(proj_version_minor),
             "CTE_PROJ_VERSION_PATCH": int(proj_version_patch),
+            "CTE_PYTHON_IMPLEMENTATION": platform.python_implementation(),
         },
         **get_cythonize_options(),
     )
-- 
2.25.1

